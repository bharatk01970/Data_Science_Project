def apply_column_combination(self, result_rows, columns_to_combine, new_column_name, 
                             reference_column='', repeat_columns=None):
    """Combine multiple columns into separate rows with optional reference-based repetition
    
    Args:
        result_rows: List of row dictionaries
        columns_to_combine: List of column names to combine
        new_column_name: Name for the new combined column
        reference_column: Column to use as reference for repetition (optional)
        repeat_columns: List of columns whose values should repeat (optional)
    
    Returns:
        List of row dictionaries with combined column, each value in separate row
    
    Example:
        A = [A1, A2, A3], B = [B1, B2] (reference), C = [C1]
        If repeat A: Output = A1, A2, A3, B1, A1, A2, A3, B2, C1
    """
    if not columns_to_combine or not new_column_name:
        return result_rows
    
    if repeat_columns is None:
        repeat_columns = []
    
    combined_rows = []
    
    for row in result_rows:
        # Collect all values from all columns to combine
        column_values = {}  # {column_name: [list of values]}
        
        for col in columns_to_combine:
            if col in row and row[col]:
                value = row[col]
                # Split multi-values
                if isinstance(value, str) and (',' in value or ';' in value):
                    split_vals = self.split_multi_values(value)
                    column_values[col] = [v for v in split_vals if v]
                else:
                    column_values[col] = [str(value)] if value else []
            else:
                column_values[col] = []
        
        # Get reference column values if specified
        ref_values = []
        if reference_column and reference_column in column_values:
            ref_values = column_values[reference_column]
        
        # If no reference or no repeat columns, just combine all values
        if not reference_column or not repeat_columns or not ref_values:
            # Simple combination - all values in order, each in separate row
            all_values = []
            for col in columns_to_combine:
                all_values.extend(column_values.get(col, []))
            
            # Create one row per value
            for value in all_values:
                new_row = {}
                # Copy non-combined columns
                for key, val in row.items():
                    if key not in columns_to_combine:
                        new_row[key] = val
                # Add combined column with single value
                new_row[new_column_name] = value
                
                if new_row not in combined_rows:
                    combined_rows.append(new_row)
        
        else:
            # Reference-based repetition
            # Logic: For each reference value, add all repeat column values, then the ref value itself
            # Pattern: [repeat_vals, ref1, repeat_vals, ref2, ..., other_vals]
            
            # Separate columns into categories
            other_columns = [col for col in columns_to_combine 
                           if col != reference_column and col not in repeat_columns]
            
            # Get the repetition count (number of reference values)
            repetition_count = len(ref_values)
            
            # For each reference value, add repeated columns + reference value
            for ref_val in ref_values:
                # Add all values from repeat columns
                for col in repeat_columns:
                    for val in column_values.get(col, []):
                        new_row = {}
                        # Copy non-combined columns
                        for key, val_orig in row.items():
                            if key not in columns_to_combine:
                                new_row[key] = val_orig
                        # Add combined column value
                        new_row[new_column_name] = val
                        
                        if new_row not in combined_rows:
                            combined_rows.append(new_row)
                
                # Add the reference value itself
                new_row = {}
                for key, val_orig in row.items():
                    if key not in columns_to_combine:
                        new_row[key] = val_orig
                new_row[new_column_name] = ref_val
                
                if new_row not in combined_rows:
                    combined_rows.append(new_row)
            
            # Add values from other (non-repeat, non-reference) columns - only once at the end
            for col in other_columns:
                for val in column_values.get(col, []):
                    new_row = {}
                    for key, val_orig in row.items():
                        if key not in columns_to_combine:
                            new_row[key] = val_orig
                    new_row[new_column_name] = val
                    
                    if new_row not in combined_rows:
                        combined_rows.append(new_row)
    
    return combined_rows







###############

def debug_column_combination(self, column_values, reference_column, repeat_columns):
    """Debug helper to verify repetition logic"""
    print("\n=== DEBUG: Column Combination ===")
    print(f"All columns and their values:")
    for col, vals in column_values.items():
        print(f"  {col}: {vals}")
    
    if reference_column:
        print(f"\nReference column: {reference_column}")
        print(f"Reference values: {column_values.get(reference_column, [])}")
        print(f"Repetition count: {len(column_values.get(reference_column, []))}")
    
    if repeat_columns:
        print(f"\nColumns to repeat: {repeat_columns}")
        for col in repeat_columns:
            print(f"  {col} values: {column_values.get(col, [])}")
    
    print("=== END DEBUG ===\n")





To use it, add this line at the beginning of apply_column_combination (after collecting column_values):



# Debug line (remove after testing)
# self.debug_column_combination(column_values, reference_column, repeat_columns)